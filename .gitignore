--==================================================
-- üîë TANPHU PREMIUM LOADER (KEY + HWID + Flask API)
-- ‚Ä¢ User d√πng:
--   getgenv().TanPhu_Key = "KEY_BOT_G·ª¨I"
--   loadstring(game:HttpGet("https://raw.githubusercontent.com/LVTP1312/tanphupremium/main/.gitignore"))()
--
-- ‚Ä¢ Khi key OK ‚Üí loader s·∫Ω load script ch√≠nh t·ª´:
--   https://raw.githubusercontent.com/LVTP1312/tanphupremium/main/tanphu_loader.lua
--   (b·∫°n ch·ªâ c·∫ßn update file tanphu_loader.lua l√† ƒë·ªß)
--==================================================

repeat task.wait() until game:IsLoaded()

local HttpService      = game:GetService("HttpService")
local Players          = game:GetService("Players")
local AnalyticsService = game:GetService("RbxAnalyticsService")

-- ‚úÖ API Flask (ngrok) c·ªßa b·∫°n
local API_BASE      = "https://reparative-mira-dominatingly.ngrok-free.dev"
local PRODUCT_NAME  = "TanPhuFinder"

-- ‚úÖ Script ch√≠nh (b·∫°n hay update file n√†y)
local PREMIUM_SCRIPT_URL = "https://raw.githubusercontent.com/LVTP1312/tanphupremium/main/tanphu_loader.lua"

--=======================
-- üîß HWID
--=======================
local function getHWID()
    local ok, cid = pcall(function()
        return AnalyticsService:GetClientId()
    end)

    if ok and cid then
        return cid
    end

    return "fallback_" .. tostring(Players.LocalPlayer.UserId)
end

--=======================
-- üîç CHECK KEY QUA API
--=======================
local function CheckKey()
    local key = getgenv().TanPhu_Key
    if not key or key == "" then
        warn("[TanPhu] B·∫°n ch∆∞a set getgenv().TanPhu_Key")
        return false
    end

    local payload = {
        key     = key,
        hwid    = getHWID(),
        product = PRODUCT_NAME,
    }

    local ok, res = pcall(function()
        return HttpService:PostAsync(
            API_BASE .. "/check_key",
            HttpService:JSONEncode(payload),
            Enum.HttpContentType.ApplicationJson,
            false
        )
    end)

    if not ok then
        warn("[TanPhu] L·ªói g·ªçi API /check_key: " .. tostring(res))
        return false
    end

    local data
    ok, data = pcall(function()
        return HttpService:JSONDecode(res)
    end)

    if not ok or type(data) ~= "table" then
        warn("[TanPhu] JSON decode l·ªói: " .. tostring(data))
        return false
    end

    if not data.ok then
        warn("[TanPhu] Key sai / h·∫øt h·∫°n / hwid mismatch: " .. tostring(data.reason))
        return false
    end

    print("[TanPhu] KEY OK | expires_at = " .. tostring(data.expires_at))
    return true
end

--=======================
-- üöÄ START
--=======================
if not CheckKey() then
    -- Key fail ‚Üí d·ª´ng loader, kh√¥ng ch·∫°y script ch√≠nh
    return
end

-- Key OK ‚Üí load script ch√≠nh (file b·∫°n hay update)
local ok, err = pcall(function()
    loadstring(game:HttpGet(PREMIUM_SCRIPT_URL))()
end)

if not ok then
    warn("[TanPhu] L·ªói load script premium: " .. tostring(err))
end
